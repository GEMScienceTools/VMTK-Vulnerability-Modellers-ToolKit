# -*- coding: utf-8 -*-
"""
Created on Fri Jan 17 08:55:51 2020

@author: LuisMartins
"""

import openseespy.opensees as ops
import numpy as np
#%%

def run_nlth_analysis_on_sdof_ops_py(capacity_curve,gmr,damping,degradation):
      
      ops.wipe()
      ops.model('basic','-ndm',1,'-ndf',1)
      
      d_vec=capacity_curve[:,0]
      f_vec=capacity_curve[:,1]*9.81
      
      if len(f_vec)==3:
            #bilinear curve
            f_vec=np.append(f_vec,[f_vec[2]/2,0])
            d_vec=np.append(d_vec,[d_vec[2],d_vec[2]])
      elif len(f_vec)==4:
            f_vec=np.append(f_vec,0)
            d_vec=np.append(d_vec,d_vec[3])
      
      matTag_pinching=10
      if degradation==True:
            
            matargs=[f_vec[1],d_vec[1],f_vec[2],d_vec[2],f_vec[3],d_vec[3],f_vec[4],d_vec[4],
                                 -1*f_vec[1],-1*d_vec[1],-1*f_vec[2],-1*d_vec[2],-1*f_vec[3],-1*d_vec[3],-1*f_vec[4],-1*d_vec[4],
                                 0.5,0.25,0.05,
                                 0.5,0.25,0.05,
                                 0,0.1,0,0,0.2,
                                 0,0.1,0,0,0.2,
                                 0,0.4,0,0.4,0.9,
                                 10,'energy']
            
      else:
            matargs=[f_vec[1],d_vec[1],f_vec[2],d_vec[2],f_vec[3],d_vec[3],f_vec[4],d_vec[4],
                                 -1*f_vec[1],-1*d_vec[1],-1*f_vec[2],-1*d_vec[2],-1*f_vec[3],-1*d_vec[3],-1*f_vec[4],-1*d_vec[4],
                                 0.5,0.25,0.05,
                                 0.5,0.25,0.05,
                                 0,0,0,0,0,
                                 0,0,0,0,0,
                                 0,0,0,0,0,
                                 10,'energy']
            
      ops.uniaxialMaterial('Pinching4', matTag_pinching,*matargs)
      matTag_minmax=matTag_pinching/10
      ops. uniaxialMaterial('MinMax', matTag_minmax,matTag_pinching, '-min',-1*d_vec[-1], '-max', d_vec[-1])
      
      mx=1
      kx=f_vec[1]/d_vec[1]
      omega=np.sqrt(kx/mx)
      dt=gmr[1,0]-gmr[0,0]
      
      ops.node(1,0)
      ops.node(2,0,'-mass',float(mx))
      ops.fix(1,1)
      gmr_values=gmr[:,1]
      gmr_times=gmr[:,0]
      ops.timeSeries('Path', 1,'-values',*gmr_values,'-time',*gmr_times,'-factor',9.81)
      ops.pattern('UniformExcitation',2,1,'-accel',1)
      
      ops.constraints('Plain')
      ops.numberer('RCM')
      ops.test('NormDispIncr',1e-6,50)
      ops.algorithm('Newton')
      ops.system('BandGeneral')
      ops.integrator('Newmark',0.5,0.25)
      ops.analysis('Transient')
      
      t_final=gmr[-1,0]
      t_current=ops.getTime()
      ok=0
      
      time= [t_current]
      disps=[0.0]
      accels=[0.0]
      ops.rayleigh(0,0,damping*2.0/omega,0)
      
      while ok == 0 and t_current < t_final:
            ok=ops.analyze(1,dt)
            if ok !=0:
                  print("regular newton failed .. lets try an initail stiffness for this step")
                  ops.test('NormDispIncr',1.0e-6,100,0)
                  ops.algorithm('ModifiedNewton', '-initial')
                  ok=ops.analyze(1,dt)
                  if ok!=0:
                        print("reducing dt by 10")
                        ndt=dt/10
                        ok=ops.analyze(10,ndt)
                  if ok==0:
                        print("that worked.. back to regular settings")
                        ops.test('NormDispIncr',1e-6,50)
                        ops.test('NormDispIncr',1e-6,50)
            t_current = ops.getTime()
            time.append(t_current)
            disps.append(ops.nodeDisp(2,1))
            accels.append(ops.nodeAccel(2,1))
      
      if ok!=0:
            print('NLTHA did not converge!')
      
      
      return time,disps,accels

#%%
      
